# pylint: disable=import-error
from VM_OrchestratorApp.src.objects.observation import Observation
from VM_Orchestrator.settings import REDMINE_IDS
from datetime import datetime
import re

regex = '\[(.*)]'

def resolve_name(vulnerability_dict, language):
    if language == 'eng':
        return vulnerability_dict['english_name']
    elif language == 'spa':
        return vulnerability_dict['spanish_name']


class Vulnerability:

    # Description is the string that will be sent to slack/redmine/report
    def __init__(self, vulnerability_dict, info, custom_description):
        if re.search(regex,vulnerability_dict['english_name']):
            self.vulnerability_name = vulnerability_dict['english_name']
            self.observation = None
            self.status = vulnerability_dict['status']
            self.vuln_type = vulnerability_dict['scan_type']
        else:
            self.vulnerability_name = resolve_name(vulnerability_dict, info['language'])
            self.observation = Observation(self.vulnerability_name, info['language'])
            self.status = vulnerability_dict['status']    
            self.vuln_type = vulnerability_dict['scan_type']
            
        self.language = info['language']
        self.domain = info['domain']
        self.target = info['target']
        self.time = datetime.now()
        self.custom_description = custom_description
        self.image_string = None
        self.file_string = None
        self.cvss = None

        self.attachment_path = None
        self.attachment_name = None

        return

    def resolve_priority(self):
        severity_dict = {'INFORMATIONAL': REDMINE_IDS['SEVERITY']['INFORMATIONAL'],
         'LOW': REDMINE_IDS['SEVERITY']['LOW'], 'MEDIUM': REDMINE_IDS['SEVERITY']['MEDIUM'],
          'HIGH': REDMINE_IDS['SEVERITY']['HIGH'], 'CRITICAL': REDMINE_IDS['SEVERITY']['CRITICAL']}
        try:
            return severity_dict[self.observation.severity]
        except (KeyError,AttributeError):
            return REDMINE_IDS['SEVERITY']['MEDIUM']

    def add_attachment(self, attachment_path, attachment_name):
        self.attachment_path = attachment_path
        self.attachment_name = attachment_name

    def add_image_string(self, image_string):
        self.image_string = image_string

    def add_file_string(self, file_string):
        self.file_string = file_string

    def get_json_observation(self):
        if re.search(regex, self.vulnerability_name):
            return None
        return_value = {
            'title': self.observation.title,
            'observation_title': self.observation.observation_title,
            'observation_note': self.observation.observation_note,
            'implication': self.observation.implication,
            'recommendation_title': self.observation.recommendation_title,
            'recommendation_note': self.observation.recommendation_urls,
            'severity': self.observation.severity
        }
        return return_value


